CREATE DATABASE COMPANY;

CREATE TABLE EMPLOYEE(EM_ID INT PRIMARY KEY, EM_LASTNAME CHAR(20), EM_FIRSTNAME CHAR(20), EM_POSITION INT, EM_DEPARTMENT INT, EM_BRANCH INT, EM_BEGIN DATE, EM_END DATE); 
CREATE TABLE POSITION(PS_ID INT PRIMARY KEY, PS_POSITION CHAR(20), PS_SALARY INT);
CREATE TABLE DEPARTMENT(D_ID INT PRIMARY KEY, D_DEPARTMENT CHAR(20), D_BEGIN DATE, D_END DATE);
CREATE TABLE BRANCH(B_ID INT PRIMARY KEY, B_BRANCH CHAR(20), B_CITY CHAR(20), B_STREET CHAR(20), B_HOUSE CHAR(20), B_BEGIN DATE, B_END DATE);
CREATE TABLE M2M_BRANCH_DEPARTMENT(B_ID INT, D_ID INT, PRIMARY KEY(B_ID, D_ID));
--CREATE TABLE BUDGET(NAME_OF_BRANCH CHAR(20) ,NAME_OF_DEPARTMENT CHAR(20), MONTH_YEAR CHAR(20), BUDGET INT);
--CREATE TABLE CLIENT(SURNAME CHAR(20), NAME CHAR(20), PRIMARY KEY(SURNAME, NAME));
CREATE TABLE EXPENSES(EX_ID INT PRIMARY KEY, EX_NAME CHAR(20), EX_AMOUNT INT, EX_EMPLOYEE INT, EX_DATE DATE);
CREATE TABLE PROFIT(PR_ID INT PRIMARY KEY, PR_NAME CHAR(20), PR_AMOUNT INT, PR_EMPLOYEE INT, PR_DATE DATE);

CREATE TABLE USERS(U_ID INT PRIMARY KEY IDENTITY, U_LOGIN CHAR(20),  U_LASTNAME CHAR(20), U_FIRSTNAME CHAR(20), U_ROLE CHAR(1));
CREATE TABLE PASSWORDS(PA_ID INT PRIMARY KEY, PA_PASSWORD CHAR(20) NOT NULL);

DROP TABLE EMPLOYEE;
DROP TABLE POSITION;
DROP TABLE DEPARTMENT;
DROP TABLE BRANCH;
DROP TABLE M2M_BRANCH_DEPARTMENT;
DROP TABLE EXPENSES;
DROP TABLE PROFIT;

DROP TABLE USERS;
DROP TABLE PASSWORDS;

ALTER TABLE EMPLOYEE ADD CONSTRAINT FK_EMPLOYEE_POSITION FOREIGN KEY (EM_POSITION) REFERENCES POSITION(PS_ID);
ALTER TABLE EMPLOYEE ADD CONSTRAINT FK_EMPLOYEE_DEPARTMENT FOREIGN KEY (EM_DEPARTMENT) REFERENCES DEPARTMENT(D_ID); 
ALTER TABLE EMPLOYEE ADD CONSTRAINT FK_EMPLOYEE_BRACH FOREIGN KEY (EM_BRANCH) REFERENCES BRANCH(B_ID);
ALTER TABLE EXPENSES ADD CONSTRAINT FK_EXPENSES_EMPLOYEE FOREIGN KEY (EX_EMPLOYEE) REFERENCES EMPLOYEE(EM_ID);
ALTER TABLE PROFIT ADD CONSTRAINT FK_PROFIT_EMPLOYEE FOREIGN KEY (PR_EMPLOYEE) REFERENCES EMPLOYEE(EM_ID);
ALTER TABLE M2M_BRANCH_DEPARTMENT ADD CONSTRAINT FK_M2M_BRANCH_DEPARTMENT_DEPARTMENT FOREIGN KEY (D_ID) REFERENCES DEPARTMENT(D_ID);
ALTER TABLE M2M_BRANCH_DEPARTMENT ADD CONSTRAINT FK_M2M_BRANCH_DEPARTMENT_BRANCH FOREIGN KEY (B_ID) REFERENCES BRANCH(B_ID);

ALTER TABLE PASSWORDS ADD CONSTRAINT FK_PASSWORDS_USERS FOREIGN KEY (PA_ID) REFERENCES USERS(U_ID);

ALTER TABLE EMPLOYEE DROP FK_EMPLOYEE_POSITION;
ALTER TABLE EMPLOYEE DROP FK_EMPLOYEE_DEPARTMENT;
ALTER TABLE EMPLOYEE DROP FK_EMPLOYEE_BRACH;
ALTER TABLE EXPENSES DROP FK_EXPENSES_EMPLOYEE;
ALTER TABLE PROFIT DROP FK_PROFIT_EMPLOYEE;
ALTER TABLE M2M_BRANCH_DEPARTMENT DROP FK_M2M_BRANCH_DEPARTMENT_DEPARTMENT;
ALTER TABLE M2M_BRANCH_DEPARTMENT DROP FK_M2M_BRANCH_DEPARTMENT_BRANCH;


ALTER TABLE PASSWORDS DROP FK_PASSWORDS_USERS;

SELECT * FROM EMPLOYEE;
SELECT * FROM POSITION;
SELECT * FROM DEPARTMENT;
SELECT * FROM BRANCH;
SELECT * FROM M2M_BRANCH_DEPARTMENT;
SELECT * FROM EXPENSES;
SELECT * FROM PROFIT;

SELECT * FROM USERS;
SELECT * FROM PASSWORDS;

INSERT INTO USERS(U_LOGIN, U_LASTNAME, U_FIRSTNAME, U_ROLE)
VALUES ('Shu Ouma', 'Ouma', 'Shu', 1), 
('Inori Yuzuriha', 'Yuzuriha', 'Inori', 2),
('Haruka Ouma', 'Ouma', 'Haruka', 3);

INSERT INTO PASSWORDS 
VALUES(2, 123),
(3, 123),
(4, 123);

INSERT INTO EMPLOYEE
VALUES(1, 'Ouma', 'Shu', 1, 1, 1122, '2015-11-11', NULL),
(2, 'Yuzuriha', 'Inori', 2, 2, 1212, '2017-09-05', NULL),
(3, 'Tsugumi', 'Sendou',  2, 1, 1212, '2016-02-10', '2018-06-01');

INSERT INTO POSITION
VALUES(1, 'Admin', 500),
(2, 'Specialist', 400);

INSERT INTO DEPARTMENT
VALUES(1, 'DEPARTMENT_1', '2010-01-01', NULL),
(2, 'DEPARTMENT_2', '2006-01-01', NULL),
(3, 'DEPARTMENT_2', '2003-01-01', '2016-01-01');

INSERT INTO BRANCH
VALUES(1122, 'BRANCH_1', 'CITY_1', 'STREET_1', 'HOUSE_1', '2007-01-01', NULL),
(1212, 'BRANCH_2', 'CITY_2', 'STREET_2', 'HOUSE_2','2004-01-01', NULL),
(1332, 'BRANCH_3', 'CITY_2', 'STREET_3', 'HOUSE_3', '2000-01-01', '2010-01-01');

INSERT INTO M2M_BRANCH_DEPARTMENT
VALUES(1122, 1),
(1122, 2),
(1212, 1),
(1212, 2);

INSERT INTO EXPENSES
VALUES(1, 'Salary', 500, 1, '2019-10-01'),
(2, 'Salary', 400, 2, '2019-10-01'),
(3, 'Depreciation expense', 650, 1, '2019-09-01');

INSERT INTO PROFIT
VALUES(1, 'Credit', 5000, 2, '2019-10-10'),
(2, 'Deposit', 1000, 2, '2019-10-12'),
(3, 'Financing', 25200, 1, '2019-11-01');

DELETE FROM EMPLOYEE;
DELETE FROM POSITION;
DELETE FROM DEPARTMENT;
DELETE FROM BRANCH;
DELETE FROM M2M_BRANCH_DEPARTMENT;
DELETE FROM EXPENSES;
DELETE FROM PROFIT;

DELETE FROM USERS;
DELETE FROM PASSWORDS;

SELECT U_LOGIN, PA_PASSWORD, U_ROLE, (CASE 
WHEN U_ROLE=1 THEN 'ADMIN'
WHEN U_ROLE=2 THEN 'EMPLOYEE'
WHEN U_ROLE=3 THEN 'USER'
END) AS ROLE
FROM USERS INNER JOIN PASSWORDS ON U_ID=PA_ID;

SELECT B_BRANCH, D_DEPARTMENT
FROM (M2M_BRANCH_DEPARTMENT M2M INNER JOIN BRANCH BR ON M2M.B_ID=BR.B_ID) INNER JOIN DEPARTMENT D ON M2M.D_ID=D.D_ID

